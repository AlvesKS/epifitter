---
title: "Fitting disease progress curves to classic epidemiological models"
author: "Kaique S Alves"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting disease progress curves to classic epidemiological models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Introduction

Use `epifitter` to fit the classic epidemiological models, *Exponential*, *Monomolecular*, *Logistic*, *Gompertz*, to your disease progress curves.

# Hands on
## Packages

First we have to load some packages. If you don't have any of theses, please install it with the function `instal.packages()`.

```{r message=FALSE, warning=FALSE}
library(epifitter)
library(ggplot2)
library(dplyr)
```


## Data

```{r}
dpc_data = sim_logistic(
  N = 100,
  y0 = 0.01,
  dt = 5,
  r = 0.1,
  alpha = 0.2,
  n = 7
)
head(dpc_data)
```

## Using `fin_lin()` 

```{r}
f_lin = fit_lin(time = dpc_data$time,
        y = dpc_data$random_y)
f_lin
```

```{r}
head(f_lin$data)
```


```{r}
head(f_lin$stats_all)
```

```{r}
plot_fit(f_lin,
         point_size = 2)+
  theme_minimal()
```

```{r}
plot_fit(f_lin,
         point_size = 2,
         models = "Logistic")+
  theme_minimal()
```

## Using `fin_nlin()`

```{r message=FALSE, warning=FALSE}
f_nlin = fit_nlin(time = dpc_data$time,
        y = dpc_data$random_y)
f_nlin
```

## Using `fin_nlin2()`

```{r message=FALSE, warning=FALSE}
f_nlin2 = fit_nlin2(time = dpc_data$time,
        y = dpc_data$random_y)
f_nlin2
```

## Using `multi_fitter`
### Data

```{r}
epi1 = sim_gompertz(N = 60, y0 = 0.001, dt = 5, r = 0.1, alpha = 0.4, n = 4)
epi2 = sim_gompertz(N = 60, y0 = 0.001, dt = 5, r = 0.12, alpha = 0.4, n = 4)
epi3 = sim_gompertz(N = 60, y0 = 0.003, dt = 5, r = 0.12, alpha = 0.4, n = 4)

multi_epidemic = bind_rows(epi1,
                           epi2,
                           epi3,
                           .id= "DPC")
head(multi_epidemic)
```

```{r}
multi_fit = multi_fitter(time_col = "time",
             intensity_col = "random_y",
             data = multi_epidemic,
             strata_cols = "DPC")
multi_fit$Parameters
```


```{r}
head(multi_fit$Data)
```

### Estimate K?

```{r}
multi_fit_K = multi_fitter(time_col = "time",
             intensity_col = "random_y",
             data = multi_epidemic,
             strata_cols = "DPC",
             nlin = T,
             estimate_K =T)
head(multi_fit_K$Parameters)
```
## Make graphics to compare curves and parameters
### Curves
```{r}
multi_fit$Data %>% 
  ggplot(aes(time, predicted, color = DPC))+
  geom_point(aes(time,y), color = "gray")+
  geom_line()+
  facet_wrap(~model, scales = "free_y")+
  theme_light()
```

```{r}
multi_fit$Data %>%
  filter(model == "Gompertz") %>% 
  ggplot(aes(time, predicted, color = DPC))+
  geom_point(aes(time,y),
             color = "gray",
             size =2)+
  geom_line(size = 1.2)+
  theme_light()+
  labs(x = "Time",
       y = "Disease Intensity")
```

### Apparent infection rate

```{r}
multi_fit$Parameters %>% 
  filter(model == "Gompertz") %>% 
  ggplot(aes(DPC,r))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = r_ci_lwr, ymax = r_ci_upr),
                width = 0,
                size=1)+
  labs(x = "Time",
       y = "Apparent infection rate")+
  theme_light()
```


